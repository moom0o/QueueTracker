<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
<script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
<script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/themes/adaptive.js"></script>
<title>2b2t Queue Statistics</title>
<link rel="icon" type="image/png" href="/favicon.png" />



<div id="container"></div>
<script>
(async () => {

    const names = ['InGame', 'Regular', 'Prio', 'Total'];

    /**
     * Create the chart when all data is loaded
     * @return {undefined}
     */
    function createChart(series) {

        return Highcharts.stockChart('container', {
            time: {
                timezone: 'America/New_York'
            },
            title: {
                text: ``
            },
            subtitle: {
                text: 'API: <a href="/current">/current</a> <a href="/all">/all</a> <a href="/regular">/regular</a> <a href="/prio">/prio</a> <a href="/ingame">/ingame</a> <a href="/total">/total</a> - <a href="https://github.com/moom0o/QueueTracker">GitHub</a>'
            },
            rangeSelector: {
                buttons: [
                    {
                        type: 'hour',
                        count: 1,
                        text: '1h'
                    },
                    {
                        type: 'hour',
                        count: 24,
                        text: '24h'
                    },
                    {
                        type: 'day',
                        count: 7,
                        text: '7d'
                    },
                    {
                        type: 'day',
                        count: 14,
                        text: '14d'
                    },
                    {
                        type: 'day',
                        count: 30,
                        text: '30d'
                    },
                    {
                        type: 'all',
                        text: 'All'
                    }
                ],
                selected: 5
            },
            legend: { // <-- ADD THIS BLOCK
                enabled: true
            },
            yAxis: {
                labels: {
                    format: '{#if (gt value 0)}{/if}{value}'
                },
                plotLines: [{
                    value: 0,
                    width: 2,
                    color: 'silver'
                }]
            },

            plotOptions: {
                series: {
                    showInNavigator: true
                }
            },

            tooltip: {
                pointFormat: '<span style="color:{series.color}">' +
                    '{series.name}</span>: <b>{point.y}</b>',
                valueDecimals: 0,
                split: true
            },

            series
        });
    }
    const response = await fetch(
        'all'
    );
    const resdata = await response.json();
    const series = [];
    for (const name of names) {
        let data = getPart(resdata, name)
        series.push({ name,  data});
    }
    function getPart(data, string){
        return data.map(b => {
            return [b.time, b[string.toLowerCase()]];
        });
    }
    let title = ''
    let foundtime = 0

    const chart = createChart(series);
    await updateTitle()
    async function updateTitle() {
        const response = await fetch(
            'current'
        );
        const resdata = await response.json();


        foundtime = resdata.time
        title = `Regular: ${resdata.regular} - Prio: ${resdata.prio} - In-Game: ${resdata.ingame} - Total: ${resdata.total}`
        let t = Math.floor((new Date() - foundtime)/1000);
        let time = (t > 60 ? Math.floor(t / 60) +
            " minute(s) " + (t - Math.floor(t / 60) * 60) + " seconds" : t +
            " seconds") + " ago" + (Math.floor(t / 60) > 10 ?
            " (server may be down)" : "");
        chart.setTitle({
            text: title + ` - ${time}`
        })
        names.forEach((name, index) => {
            const key = name.toLowerCase();
            const value = resdata[key];

            const isLast = (index === names.length - 1);

            if(value != null){
                chart.series[index].addPoint([resdata.time, value], isLast, true)
            }
        })
    }
    setInterval(async () => {
        await updateTitle()
    }, 10000)
    setInterval(async () => {
        let t = Math.floor((new Date() - foundtime)/1000);
        let time = (t > 60 ? Math.floor(t / 60) +
            " minute(s) " + (t - Math.floor(t / 60) * 60) + " seconds" : t +
            " seconds") + " ago" + (Math.floor(t / 60) > 10 ?
            " (server may be down)" : "");
        chart.setTitle({
            text: title+ ` - ${time}`
        })
    }, 1000)
})();
</script>

<style>
    body {
        margin: 0; /* Add this line */
        background: var(--highcharts-background-color);
        color: var(--highcharts-neutral-color-100);
    }

    a:visited {
        color: #0099ff;
    }

    #container {
        height: 100vh;
        min-width: 310px;
    }

</style>